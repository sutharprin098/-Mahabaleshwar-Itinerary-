<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mahabaleshwar Smart Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1f3c88">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- LAYOUT --- */
body, html { margin:0; padding:0; font-family:'Segoe UI', sans-serif; height:100%; background:#f8f9fa; overflow:hidden; }
.app-container { display:flex; height:100vh; width:100vw; }

/* --- MAP & PANEL --- */
#map { flex-grow:1; height:100%; z-index:1; }
.panel {
  background:white; padding:20px; box-shadow:5px 0 25px rgba(0,0,0,0.15); z-index:1000;
  display:flex; flex-direction:column; overflow-y:auto; width:360px; min-width:320px;
}

/* --- PHOTO MARKERS --- */
.marker-pin {
  width: 64px; height: 64px; 
  border-radius: 50%; border: 4px solid #ffffff;
  box-shadow: 0 8px 15px rgba(0,0,0,0.4); 
  background-size: cover; background-position: center; background-color: #ddd;
  transition: transform 0.3s;
}
.marker-pin:hover { transform: scale(1.2); border-color: #3498db; z-index:9999!important; }

/* --- WEATHER BADGE --- */
.weather-badge {
  background: white; color: #333; padding: 5px 12px; border-radius: 20px; 
  font-weight: bold; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid #f39c12;
  white-space: nowrap; text-align: center;
}

/* --- GLOWING ROAD --- */
.route-glow path { filter: drop-shadow(0 0 8px rgba(52, 152, 219, 0.7)); }

/* --- UI ELEMENTS --- */
h2 { margin-top:0; color:#1f3c88; display:flex; align-items:center; gap:10px; }
.days-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; }

button {
  padding:12px; border:1px solid #e0e0e0; background:white; border-radius:8px; 
  cursor:pointer; font-weight:600; color:#444; transition:0.2s; margin-bottom: 5px;
}
button:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,0.05); }
button.active { background:#1f3c88; color:white; border-color:#1f3c88; }

.btn-weather { width:100%; background:#f39c12; color:white; border:none; margin-bottom:10px; }
.btn-weather.on { background:#27ae60; }
.btn-weather.loading { background:#bdc3c7; cursor:wait; }
.btn-pdf { width:100%; background:#e74c3c; color:white; border:none; margin-bottom:10px; }
.btn-admin { width:100%; background:#2c3e50; color:white; border:none; margin-top: auto; }

.stats-box {
  background: linear-gradient(135deg, #3498db, #2980b9); color:white;
  padding:15px; border-radius:10px; margin-bottom:15px; font-size:14px;
  display:none; animation: slideUp 0.5s ease-out;
}
@keyframes slideUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

/* --- ADMIN MODAL --- */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
.modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color:#555; }
.form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }

@media(max-width:768px){ .app-container{ flex-direction:column; } #map{ height:60vh; order:1; } .panel{ width:100%; height:40vh; order:2; border-radius:20px 20px 0 0; margin-top:-20px; padding:20px; box-sizing:border-box; } .leaflet-routing-container { display:none!important; } }

/* --- PDF TEMPLATE --- */
#pdf-template { display:none; padding: 20px; font-family: sans-serif; background:white; width: 700px; }
.pdf-header { text-align: center; color: #1f3c88; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
.pdf-map-container { width: 100%; height: 350px; border: 2px solid #1f3c88; margin-bottom: 20px; overflow:hidden; border-radius:8px; }
.pdf-map-img { width: 100%; height: 100%; object-fit: cover; }
.pdf-stats { background: #f0f4f8; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; text-align:center; }
.pdf-item { display: flex; gap: 15px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px; page-break-inside: avoid; background:#fff; }
.pdf-img { width: 100px; height: 80px; object-fit: cover; border-radius: 6px; border:1px solid #ddd; }
.pdf-info h3 { margin: 0 0 5px 0; color: #333; font-size:16px; }
.pdf-info p { margin: 2px 0; font-size:12px; color:#555; }
</style>
</head>

<body>

<div class="app-container">
  <div class="panel">
    <h2>‚õ∞Ô∏è Mahabaleshwar GIS</h2>
    
    <button class="btn-weather" id="weatherBtn" onclick="toggleWeather()">‚òÅÔ∏è Click for Live Weather</button>
    <div class="stats-box" id="routeInfo"></div>

    <div class="days-grid">
      <button onclick="showDay(1, this)">Day 1<br><small>Waterfalls</small></button>
      <button onclick="showDay(2, this)">Day 2<br><small>Panchgani</small></button>
      <button onclick="showDay(3, this)">Day 3<br><small>History</small></button>
      <button onclick="showDay(4, this)">Day 4<br><small>Tapola</small></button>
    </div>
    
    <button class="btn-pdf" onclick="downloadPDF()">üìÑ Download PDF (with Map)</button>

    <button class="btn-admin" onclick="openAdmin()">‚öôÔ∏è Edit Photos (Admin)</button>
    <div style="text-align:center; margin-top:5px; font-size:10px; color:#888;">Data v3.0 Loaded</div>
  </div>
  <div id="map"></div>
</div>

<div id="adminModal" class="modal">
  <div class="modal-content">
    <h3>Update Photos</h3>
    <div id="adminForm"></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="saveAdminData()" style="flex:1; background:#1f3c88; color:white;">üíæ Save</button>
      <button onclick="document.getElementById('adminModal').style.display='none'" style="flex:1; background:#7f8c8d; color:white;">Cancel</button>
    </div>
    <button onclick="hardReset()" style="width:100%; margin-top:10px; background:white; color:red; border:1px solid red; padding:5px;">‚ö†Ô∏è Factory Reset</button>
  </div>
</div>

<div id="pdf-template"></div>

<script>
// --- 1. NEW IMAGE DATA ---
var APP_VERSION = "3.0"; 
var RESORT = [17.9258, 73.6560];

var DEFAULT_DAYS = {
  1: { 
    route: [RESORT, [17.9235, 73.6470], [17.9355, 73.6735], [17.9420, 73.7055], RESORT], 
    points: [ 
      {name: "Venna Lake", lat: 17.9235, lng: 73.6470, alt: "1400m", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/Venna_Lake_Mahabaleshwar.jpg/800px-Venna_Lake_Mahabaleshwar.jpg", desc: "Boating & Horse Riding"}, 
      {name: "Lingmala Falls", lat: 17.9355, lng: 73.6735, alt: "1250m", img: "https://www.trawell.in/admin/images/upload/128612903Mahabaleshwar_Lingmala_Waterfalls_Main.jpg", desc: "Spectacular Waterfall"}, 
      {name: "Kate‚Äôs Point", lat: 17.9420, lng: 73.7055, alt: "1290m", img: "https://upload.wikimedia.org/wikipedia/commons/2/22/Kate%27s_Point.jpg", desc: "Elephant Head View"} 
    ] 
  },
  2: { 
    route: [RESORT, [17.9400, 73.7370], [17.9330, 73.7340], [17.9250, 73.8010], RESORT], 
    points: [ 
      {name: "Mapro Garden", lat: 17.9400, lng: 73.7370, alt: "1350m", img: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Mapro_Garden.jpg", desc: "Strawberry & Chocolate"}, 
      {name: "Bhilar Book Village", lat: 17.9330, lng: 73.7340, alt: "1300m", img: "https://static.toiimg.com/thumb/msid-58532402,width-748,height-499,resizemode-4/58532402.jpg", desc: "India's First Book Village"}, 
      {name: "Panchgani Table Land", lat: 17.9250, lng: 73.8010, alt: "1334m", img: "https://upload.wikimedia.org/wikipedia/commons/e/e3/Table_Land_Panchgani.jpg", desc: "Asia's 2nd Longest Plateau"} 
    ] 
  },
  3: { 
    route: [RESORT, [17.9380, 73.5800], [17.9310, 73.6510], RESORT], 
    points: [
      {name: "Pratapgad Fort", lat: 17.9380, lng: 73.5800, alt: "1080m", img: "https://upload.wikimedia.org/wikipedia/commons/3/36/Pratapgad_Fort_Pune.jpg", desc: "Historic Fort"}, 
      {name: "Mahabaleshwar Temple", lat: 17.9310, lng: 73.6510, alt: "1438m", img: "https://upload.wikimedia.org/wikipedia/commons/6/62/Mahabaleshwar_Temple.jpg", desc: "Ancient Shiva Temple"}
    ] 
  },
  4: { 
    route: [RESORT, [17.9485, 73.8880], [17.6350, 73.7450], RESORT], 
    points: [
      {name: "Wai Ganpati", lat: 17.9485, lng: 73.8880, alt: "718m", img: "https://upload.wikimedia.org/wikipedia/commons/f/f6/Dholya_Ganpati_Wai.jpg", desc: "Famous Ghat Temple"}, 
      {name: "Tapola (Mini Kashmir)", lat: 17.6350, lng: 73.7450, alt: "600m", img: "https://www.trawell.in/admin/images/upload/128612918Tapola_Main.jpg", desc: "Shivsagar Lake & Camping"}
    ] 
  }
};

// AUTO-FIX: Force update if version changes to load new images
if(localStorage.getItem('appVersion') !== APP_VERSION) {
    localStorage.clear(); 
    localStorage.setItem('appVersion', APP_VERSION);
}
var DAYS = JSON.parse(localStorage.getItem('tourData')) || DEFAULT_DAYS;

// MAP INIT
var map = L.map('map', {zoomControl: false, preferCanvas: true}).setView([17.9258, 73.6560], 11);
L.control.zoom({ position: 'topright' }).addTo(map);
// CORS Fix for PDF Generation
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', crossOrigin: 'anonymous' }).addTo(map);

var markerGroup = L.layerGroup().addTo(map);
var weatherGroup = L.layerGroup().addTo(map);
var routeControl = null;
var currentDay = 1;
var currentStats = ""; 
var isWeatherOn = false;

function showDay(d, btn){
  currentDay = d;
  document.querySelectorAll('.days-grid button').forEach(b => b.classList.remove('active')); 
  if(btn) btn.classList.add('active');
  markerGroup.clearLayers();
  if(routeControl) { map.removeControl(routeControl); routeControl = null; }

  var infoBox = document.getElementById("routeInfo");
  infoBox.style.display = 'block';
  infoBox.innerHTML = "üöó Calculating Route...";

  // Resort
  var resortIcon = L.divIcon({ className:'', html: `<div class="marker-pin" style="background-image:url('https://cdn-icons-png.flaticon.com/512/139/139899.png'); background-size:60%; background-color:#fff;"></div>`, iconSize: [64, 64], iconAnchor: [32, 32] });
  L.marker(RESORT, {icon: resortIcon}).addTo(markerGroup).bindPopup("<b>Base Camp</b>");

  // Points
  DAYS[d].points.forEach((p, i) => {
    var alt = p.alt ? p.alt : "N/A";
    setTimeout(() => {
      var photoIcon = L.divIcon({ className:'', html: `<div class="marker-pin" style="background-image:url('${p.img}');"></div>`, iconSize: [64, 64], iconAnchor: [32, 32], popupAnchor: [0, -35] });
      var popupContent = `<div style="text-align:center;"><img src="${p.img}" style="width:100%; height:130px; object-fit:cover; border-radius:5px;"><h3 style="margin:5px 0; color:#1f3c88;">${p.name}</h3><p style="margin:0; font-size:12px; color:#555;">${p.desc}</p><div style="background:#e3f2fd; color:#1565c0; padding:3px 8px; border-radius:4px; font-size:11px; display:inline-block; margin-top:5px; font-weight:bold;">‚õ∞Ô∏è Elev: ${alt}</div></div>`;
      L.marker([p.lat, p.lng], {icon: photoIcon}).addTo(markerGroup).bindPopup(popupContent);
    }, i * 150);
  });

  // Route
  routeControl = L.Routing.control({
    waypoints: DAYS[d].route.map(c => L.latLng(c[0],c[1])),
    router: L.Routing.osrmv1({serviceUrl: "https://router.project-osrm.org/route/v1"}),
    lineOptions: { styles: [{color: 'white', opacity: 0.9, weight: 8}, {color: '#3498db', opacity: 1, weight: 5, className: 'route-glow'}] },
    createMarker: function() { return null; }, addWaypoints: false, fitSelectedRoutes: false
  })
  .on('routesfound', function(e) {
    var r = e.routes[0];
    var dist = (r.summary.totalDistance/1000).toFixed(1);
    var time = (r.summary.totalTime/3600).toFixed(1);
    currentStats = `Distance: ${dist} km | Drive Time: ${time} hrs`;
    infoBox.innerHTML = `<div style="font-weight:bold; font-size:15px;">Day ${d} Summary</div><div style="margin-top:5px;">üìè ${dist} km &nbsp;|&nbsp; ‚è±Ô∏è ${time} hrs</div>`;
    var pad = window.innerWidth < 768 ? [20, 200] : [50, 50];
    map.flyToBounds(L.polyline(r.coordinates).getBounds(), { paddingBottomRight: window.innerWidth < 768 ? [0, 200] : [0,0], duration: 1.5 });
  })
  .addTo(map);

  if(isWeatherOn) fetchWeather();
}

// --- PDF DOWNLOAD FUNCTION ---
function downloadPDF() {
  var btn = document.querySelector('.btn-pdf');
  var originalText = btn.innerHTML;
  btn.innerHTML = "‚è≥ Generating PDF...";
  btn.disabled = true;

  html2canvas(document.getElementById('map'), {
    useCORS: true,
    allowTaint: true,
    ignoreElements: (node) => node.classList.contains('leaflet-control-zoom')
  }).then(canvas => {
    var mapImgData = canvas.toDataURL('image/png');
    var template = document.getElementById('pdf-template');
    var html = `
      <div class="pdf-header"><h1>Mahabaleshwar Trip - Day ${currentDay}</h1></div>
      <div class="pdf-map-container"><img src="${mapImgData}" class="pdf-map-img"></div>
      <div class="pdf-stats">${currentStats || "Route Calculating..."}</div>
      <h2>Itinerary Details:</h2>
    `;

    DAYS[currentDay].points.forEach(p => {
      var alt = p.alt ? p.alt : "N/A";
      html += `
        <div class="pdf-item">
          <img src="${p.img}" class="pdf-img" crossorigin="anonymous">
          <div class="pdf-info">
            <h3>${p.name}</h3><p>${p.desc}</p><p><strong>Elevation:</strong> ${alt}</p>
          </div>
        </div>`;
    });

    template.innerHTML = html;
    template.style.display = 'block';

    var opt = {
      margin: 10,
      filename: `Mahabaleshwar_Day_${currentDay}_Itinerary.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().from(template).set(opt).save().then(() => {
        template.style.display = 'none';
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
  }).catch(err => {
    alert("Map Capture Error: Please allow image loading.");
    console.error(err);
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function openAdmin(){ var m=document.getElementById("adminModal"),f=document.getElementById("adminForm"),h=`<p style="font-size:12px;color:#666;">Editing Day ${currentDay}</p>`; DAYS[currentDay].points.forEach((p,i)=>{h+=`<div class="form-group"><label>üì∏ ${p.name} URL:</label><input type="text" id="img_${i}" value="${p.img}"></div>`}); f.innerHTML=h; m.style.display="flex"; }
function saveAdminData(){ DAYS[currentDay].points.forEach((p,i)=>{var v=document.getElementById(`img_${i}`).value; if(v)p.img=v}); localStorage.setItem('tourData',JSON.stringify(DAYS)); document.getElementById("adminModal").style.display="none"; showDay(currentDay); }
function hardReset(){ if(confirm("Reset Data?")){localStorage.clear();location.reload();} }
async function toggleWeather(){ isWeatherOn=!isWeatherOn; var b=document.getElementById('weatherBtn'); if(!isWeatherOn){ weatherGroup.clearLayers(); b.classList.remove('on'); b.innerHTML="‚òÅÔ∏è Click for Live Weather"; return; } b.innerHTML="‚è≥ Fetching..."; b.classList.add('loading'); await fetchWeather(); b.classList.remove('loading'); b.classList.add('on'); b.innerHTML="‚úÖ Live Weather ON"; }
async function fetchWeather(){ weatherGroup.clearLayers(); for(let p of DAYS[currentDay].points){ try{ let r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.lat}&longitude=${p.lng}&current_weather=true`), d=await r.json(), i=d.current_weather.weathercode>3?"‚òÅÔ∏è":"‚òÄÔ∏è"; L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:`<div class="weather-badge">${d.current_weather.temperature}¬∞C ${i}</div>`,iconSize:[60,25],iconAnchor:[30,55]}),interactive:false}).addTo(weatherGroup); }catch(e){} } }

showDay(1, document.querySelectorAll('.days-grid button')[0]);
</script>
</body>
</html>
